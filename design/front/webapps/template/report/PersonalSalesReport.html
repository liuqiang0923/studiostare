<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=720, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>Sales Report</title>
	
	<link rel="stylesheet" type="text/css" href="../../css/style.css" media="screen" />
	<script src="/js/util.js"></script>
	<script src="/js/page.js"></script>
	<script src="/js/calendar.js"></script>
	<script src="/js/zepto.min.js"></script>
	<script language="javascript"> 
		var userid = '${user.operId}',orguserid = userid;
		var usersdiv, userfield;
		function init() {
			usersdiv = byId('usersdiv'), userfield = byId('userfield');
			if (userfield) {
				var fpos = pos(userfield);
				usersdiv.style.top = (fpos.y+25)+'px', usersdiv.style.left = fpos.x+'px';
			}
		}
		function pos(element) {
	        var point = { x: element.offsetLeft, y: element.offsetTop };
	        if (element.offsetParent) {
	            var parentPoint = pos(element.offsetParent);
	            point.x += parentPoint.x;
	            point.y += parentPoint.y;
	        }
	        return point;
	    };
	    function loadReport(pageNo) {
	    	pageNo = isNaN(parseInt(pageNo)) ? 1 : pageNo;
	    	var startAt = getValue("startAt");
	    	var endAt = getValue("endAt");
	    	
	    	var data = '{"body":{"querysaleid":"'+userid+'","pageno":"'+pageNo+'"';
	    	data += ',"orderby":"'+lastOrderBy+'","startat":"'+startAt+'","endat":"'+endAt+'"}}'
	    	
	    	progress(1);
	    	$.ajax({type: "POST",dataType: "json",
		        url: '/spi/querySaleInfo.do',
		        data: data, headers:{'_x_sessionid':'${sessionId}'},
		        success: function(data){ 
			        buildReport(data);
		        }
		    });
	    }
	    function buildReport(data) {
	    	progressReset();
	    	var rpttable = byId('rpttable');
	    	var rows = rpttable.rows;
	    	for (var i=rows.length-1; i>0; i--) {
	    		rpttable.deleteRow(i);
	    	}
	    	clearPageBar('pagenav');
	    	
	    	var reports = data.reports;
	    	if (reports && reports.length>0) {
	    		for (var i=0;i<reports.length;i++) {
	    			var row = rpttable.insertRow(rpttable.rows.length);
	    			var report = reports[i];
	    			
	    			var ci=0;
	    			var cell = row.insertCell(ci++);
	    			cell.innerHTML = '<td>'+report.date+'</td>';
	    			
	    			cell = row.insertCell(ci++);
	    			cell.innerHTML = '<td>'+report.salename+'</td>';
	    			
	    			cell = row.insertCell(ci++);
	    			cell.innerHTML = '<td>'+report.tradecount+'</td>';
	    			
	    			cell = row.insertCell(ci++);
	    			cell.innerHTML = '<td>'+report.tradearea+'</td>';
	    			
	    			cell = row.insertCell(ci++);
	    			cell.innerHTML = '<td>'+report.tradeprice+'</td>';
	    		}
	    		
	    		var page= data.page;
	    		generatePageBar(page.pageno, page.totalpage, 'pagenav', 'loadReport');
	    	} else {
	    		var row = rpttable.insertRow(rpttable.rows.length);
	    		var cell = row.insertCell(ci++);
	    		cell.setAttribute('colspan',5);
	    		cell.innerHTML = '暂无交易记录';
	    	}
	    }
	    var lastOrderBy = 'desc';
	    function setOrder(orderBy) {
	    	if (orderBy == lastOrderBy) return;
	    	
	    	lastOrderBy = orderBy;
	    	if (orderBy == 'asc') {
	    		byId('divasc').className = 'asc ativ';
	    		byId('divdesc').className = 'desc';
	    	} else {
	    		byId('divasc').className = 'asc';
	    		byId('divdesc').className = 'desc ativ';
	    	}
	    	loadReport(1);
	    }
	    
	    function searchUser(k) {
	    	k = trimStr(k);
	    	if (k.length < 1) {
	    		hide(usersdiv);
	    		return;
	    	}
	    	
	    	var data = '{"body":{"key":"'+getValue('userfield')+'"}}'
	    	
	    	$.ajax({type: "POST",dataType: "json",
		        url: '/spi/queryChannelUser.do',
		        data: data, headers:{'_x_sessionid':'${sessionId}'},
		        success: function(data){ 
			        showUsers(data);
		        }
		    });
	    }
	    function showUsers(data) {
	    	var users = data.results;
	    	if (!users || users.length < 1) {
		    	usersdiv.innerHTML = '<div class=r>没有相关记录</div>';
	    	} else {
	    		var h = '';
	    		for (var i=0; i<users.length; i++) {
	    			h += '<div class=r onclick="lu('+users[i].id+',\''+users[i].name+'\')">'+users[i].name+'</div>';
	    		}
	    		usersdiv.innerHTML = h;
	    	}
	    	show(usersdiv);
	    }
	    function lu(id, name) {
			event.stopPropagation();
	    	userid = id;
	    	userfield.value = name;
	    	userfield.setAttribute('lastname', name);
	    	hide(usersdiv);
	    	loadReport(1);
	    }
	    $(document).bind("click", function(event){
	    	if (usersdiv.style.display != 'none') {
				hide('usersdiv');
				userfield.value = userfield.getAttribute('lastname');
			}
		});
	</script>
	
</head>
<body onload="init();loadReport()">
		<div class='datadiv'>
<div class="search">
 <div class="fl">

		<input type="text" name="startAt" id="startAt" readonly class='datepickr' 
			placeholder="开始日期" onclick='javascript:calendar.setHook(this)'>
		<input type="text" name="endAt" id="endAt" readonly class='datepickr' 
			placeholder="结束日期" onclick='javascript:calendar.setHook(this)'>
		<#if ismanager?exists && ismanager=="true">
		<input type="text" id="userfield" placeholder="选择置业顾问" value='${user.operName}'
			onkeyup='searchUser(this.value)' lastname='${user.operName}'>
		 </#if>
		<div class="actionbtn1" onclick="cssclick(this,'actionbtn1','actionbtn2')">
        <div class="searchbox"><a href=""   onclick="loadReport()"></a></div>
			<div id="progressbar" style="display:none"><div id='progressblock'></div></div>
		</div>
        </div>
		<div class="fr">
			<div class="txt">成交排序</div>
			<div class="asc" id="divasc" onclick="setOrder('asc')">升</div>
			<div class="desc ativ" id="divdesc" onclick="setOrder('desc')">降</div>
		</div>
	</div>
		<table id='rpttable' class="datatable_list" cellpadding="0" cellspacing="0">
			<tr>
				<th>日期</th>
				<th>置业顾问</th>
				<th>成交套数</th>
				<th>成交面积（平方米）</th>
				<th>成交金额（万元）</th>
			</tr>
		</table>
        	<div id='pagenav' class='pagenav'></div>
	<div id='usersdiv' class='floatsearch' style='display:none'></div>

	</div>
</body>